function H5playerStreamManager(e,t){this._roomId=e.roomId,this._host=e.host,this._callback=t,this._lineIndex=0,this._isAutoSelectLine=!0,this._streamProtocol=2,this._host||(this._host="https://chushou.tv"),this.getPlayUrl()}function H5playerGiftcomboAnimation(e,t){this.queue=e,this.SINGLE_TEXT_WIDTH=7,this.giftcomboAnimationSpeed=e.giftcomboAnimationSpeed,this.comboAnimationRunning=!1,this.buffer=[],this.init(t)}function H5playerSystemMessage(e,t){this.queue=e,this.SINGLE_TEXT_WIDTH=7,this.systemMessageSpeed=e.systemMessageSpeed,this.systemMessageRunning=!1,this.buffer=[],this.init(t)}function H5playerBarrageQueue(e,t){this.buffer=[],this.barrage=e.barrage,this.barrageFlySpeed=e.barrageFlySpeed,this.systemMessageSpeed=e.systemMessageSpeed,this.giftcomboAnimationSpeed=e.giftcomboAnimationSpeed,this.comboBuffer=[],this.barrageStatus=1,this.animationStatus=1,this.init(t)}function H5playerBarrageTunnelManager(e,t){this.videoId=e.videoId,this.singleTunnelHeight=e.singleTunnelHeight,this.barragePosition=e.barragePosition,this.tunnelCount=0,this.BARRAGE_POSITION_NOTFULL_SCREEN=.3,this.callback=t,this.tunnels=[],this.calculating=!1,this.calculateTimeStamp=0,this.init()}function H5playerBarrageBulletManager(e,t){this.userUid=e.userUid||"",this.store=[],this.callback=t,this.init()}function H5playerBarrage(e,t){this.player=e.player,this.videoId=e.videoId,this.userUid=e.userUid,this.singleTunnelHeight=e.singleTunnelHeight,this.barrageFlySpeed=e.barrageFlySpeed,this.barrageCheckTime=e.barrageCheckTime,this.barrageSpeedMode=e.barrageSpeedMode,this.barrageMaxSpeed=e.barrageMaxSpeed,this.longBarrageNeedTime=e.longBarrageNeedTime,this.giftcomboAnimationSpeed=e.giftcomboAnimationSpeed,this.systemMessageSpeed=e.systemMessageSpeed,this.SINGLE_TEXT_WIDTH=13.5,this.firing=!1,this.isAysnc=0,this.callback=t,this.checkTime=0,this.barrageInit(e)}function H5playerLive(e,t){this.roomId=e.roomId,this.host=e.host,this.videoId=e.videoId,this.callback=t,this.stream=null,this.COOKIE_NAME=e.cookieName,this.COOKIE_EXPIRE_DAYS=e.cookieExpireDays,this.DEFAULT_VOLUME=e.defaultVolume,this.main=e.main,this.isLiving=!1,this.waitingTime=null,this.waitingTimeProtectSwitch=!1,this.WAITING_TIME=2e4,this.getLiveStreamUrl(!0,t)}function H5playerControlBar(e,t){this.player=e.player,this.barrage=e.barrage,this.videoId=e.videoId,this.main=e.main,this.videoRotateDeg=0,this.isFullScreen=!1,this.callback=t,this.init()}function H5player(e){this.h5playerVersion="0.0.1",this.roomId=e.roomId||"",this.videoId=e.videoId||"h5player-video",this.userUid=e.userUid||"",this.anchorName=escapeString(e.anchorName)||"主播",this.host=e.host||"https://chushou.tv",this.COOKIE_NAME="h5player",this.COOKIE_EXPIRE_DAYS=7,this.DEFAULT_VOLUME=50,this.DEFAULT_BARRAGE_SWITCH=1,this.DEFAULT_BARRAGE_FULLSCREEN_INPUT_SWITCH=1,this.DEFAULT_BARRAGE_OPACITY=0,this.DEFAULT_BARRAGE_POSITION=0,this.SINGLE_TUNNEL_HEIGHT=36,this.BARRAGE_FLY_SPEED=120,this.SYSTEM_MESSAGE_FLY_SPEED=100,this.GIFTCOMBO_ANIMATION_FLY_SPEED=120,this.BARRAGE_CHECK_TIME=300,this.logDebugSwitch=!1,this.BARRAGE_SPEED_MODE=0,this.BARRAGE_MAX_SPEED=200,this.LONG_BARRAGE_NEED_TIME=3,this.mediaInfo={width:1280,height:720},window.h5playerLogLevel=0}H5playerStreamManager.prototype.setRoomId=function(e){this._roomId=e,this._definition=null,this._lineIndex=0,this.getPlayUrl()},H5playerStreamManager.prototype.getCurrentStreamUrl=function(){return this.streamData&&this._lineIndex>=0&&this._lineIndex<this.streamData.length?this.streamData[this._lineIndex].url:""},H5playerStreamManager.prototype.setStreamDefinition=function(e){return!!(this.streamData&&e>=0&&e<this.streamData.length)&&(this._lineIndex=e,!0)},H5playerStreamManager.prototype.getStreamNameList=function(){var e=[];if(this.streamData)for(var t=0;t<this.streamData.length;++t){var i={};switch(this.streamData[t].def){case"sd":i={str:"["+this.streamData[t].name+"]标清",def:this.streamData[t].def};break;case"hd":i={str:"["+this.streamData[t].name+"]高清",def:this.streamData[t].def};break;case"shd":i={str:"["+this.streamData[t].name+"]超清",def:this.streamData[t].def}}i&&e.push(i)}return e},H5playerStreamManager.prototype.getCurrentStreamDefinition=function(){return this._definition},H5playerStreamManager.prototype.getCurrentStreamDefinitionIndex=function(){return this._lineIndex},H5playerStreamManager.prototype.getPlayUrl=function(){if(!this._roomId||isNaN(this._roomId))return this._callback&&this._callback("非法roomId"),!1;var e=this,t={url:this._host+"/h5player/video/get-play-url.htm?roomId="+this._roomId+"&protocols=2",type:"get",cache:!1,dataType:"jsonp",success:function(t){e.parseData(t)},error:function(e){this._callback(JSON.stringify(e))}};$.ajax(t)},H5playerStreamManager.prototype.parseData=function(e){if(e)if(0==e.code&&e.data){this.streamData=[];for(var t=0;t<e.data.length;++t)e.data[t].shdPlayUrl&&this.streamData.push({def:"shd",protocol:e.data[t].protocol,name:e.data[t].name,liveSourceId:e.data[t].liveSourceId,url:e.data[t].shdPlayUrl}),e.data[t].hdPlayUrl&&this.streamData.push({def:"hd",protocol:e.data[t].protocol,name:e.data[t].name,liveSourceId:e.data[t].liveSourceId,url:e.data[t].hdPlayUrl}),e.data[t].sdPlayUrl&&this.streamData.push({def:"sd",protocol:e.data[t].protocol,name:e.data[t].name,liveSourceId:e.data[t].liveSourceId,url:e.data[t].sdPlayUrl});this.selectLine(),this._callback&&this._callback()}else 405==e.code?this._callback&&this._callback():this._callback&&this._callback();else console.log("H5playerStreamManager parsedata error")},H5playerStreamManager.prototype.selectLine=function(){if(!this._definition)for(var e=0;e<this.streamData.length;++e)if(this._streamProtocol==this.streamData[e].protocol&&1!=this.streamData[e].liveSourceId){this._lineIndex=e;break}},H5playerStreamManager.prototype.clear=function(){this.streamData=[]},H5playerGiftcomboAnimation.prototype={init:function(e){e(this)},getConfig:function(){return{barImgs:{textBarImg0:MAIN_PIC_PREFIX_PATH+"/h5player/combo/1/bar0.png",textBarImg1:MAIN_PIC_PREFIX_PATH+"/h5player/combo/1/bar1.png",textBarImg2:MAIN_PIC_PREFIX_PATH+"/h5player/combo/1/bar2.png"}}},clearBuffer:function(){this.buffer=[]},handOver:function(e){this.comboAnimationRunning?this.buffer.push(e):this.prepare(e)},prepare:function(e,t){var i=this;this.comboAnimationRunning=!0;var a=$("#live-h5player-container").width(),n=Math.floor(this.queue.barrage.getBarrageContentLen(e.combotext.pureStr)*this.SINGLE_TEXT_WIDTH),r=n-30-20;n-=20,$("#giftcombo-animation .giftcombo-img").attr("src",e.icon),$("#giftcombo-animation .middle-bar").css("width",r+"px"),$("#giftcombo-animation .giftcombo-text").html(e.combotext.str).css("width",n+"px");var s=H5player.isThisBrowser("safari")?81:0,o=a+30-s,l=n+30+20+30;$("#giftcombo-animation").css({display:"block",width:l+"px",left:o+"px",transform:"translateX(0)"});var h=$("#giftcombo-animation").width()+o,c=(h/this.giftcomboAnimationSpeed).toFixed(2),u=e.bgUrl;this.setImg(u,r,function(){i.run(h,c)})},setImg:function(e,t,i){try{var a=document.getElementById("left-bar"),n=document.getElementById("right-bar"),r=document.getElementById("middle-bar");r.width=t;var s=a.getContext("2d"),o=n.getContext("2d"),l=r.getContext("2d"),h=new Image;h.src=e,h.onload=function(){s.drawImage(h,0,0,100,56,0,0,50,28),o.drawImage(h,110,0,100,56,0,0,50,28),l.drawImage(h,100,0,10,56,0,0,t,28),i()}}catch(c){window.console&&console.log("canvas set image exception "+c);var u=this.getConfig();$("#giftcombo-animation .left-bar").css({background:"url("+u.barImgs.textBarImg0+") no-repeat",backgroundSize:"50px 28px"}),$("#giftcombo-animation .middle-bar").css({background:"url("+u.barImgs.textBarImg1+") repeat",backgroundSize:t+"px 28px"}),$("#giftcombo-animation .right-bar").css({background:"url("+u.barImgs.textBarImg2+") no-repeat","background-size":"50px 28px"}),i()}},run:function(e,t){var i=this;setTimeout(function(){$("#giftcombo-animation").css({transform:"translateX(-"+e+"px)",transition:"transform "+t+"s linear 0s"})},50),setTimeout(function(){if($("#giftcombo-animation").css({transition:"none"}),i.comboAnimationRunning=!1,0!=i.buffer.length){var e=i.buffer.shift();i.prepare(e)}},1e3*t)},isSafari:function(){var e=navigator.userAgent.toLowerCase();return!!/version\/([\d.]+).*safari/.test(e)}},H5playerSystemMessage.prototype={init:function(e){e(this)},clearBuffer:function(){this.buffer=[]},handOver:function(e){this.systemMessageRunning?this.buffer.push(e):this.prepare(e)},prepare:function(e){this.systemMessageRunning=!0;var t=$("#live-h5player-container").width(),i=Math.floor(this.queue.barrage.getBarrageContentLen(e.pureStr)*this.SINGLE_TEXT_WIDTH),a=i-28-10;$("#system-message .middle-bar").css({width:a,"background-size":a+"px 24px"}),$("#system-message .message-content").html(e.str).css("width",i+"px");var n=i+80,r=t+n;$("#system-message").css({display:"block",width:n+"px",left:t+"px",transform:"translateX(0)"});var s=(r/this.systemMessageSpeed).toFixed(2);this.run(r,s)},run:function(e,t){var i=this;setTimeout(function(){$("#system-message").css({transform:"translateX(-"+e+"px)",transition:"transform "+t+"s linear 0s"})},50),setTimeout(function(){if($("#system-message").css({transition:"none"}),i.systemMessageRunning=!1,0!=i.buffer.length){var e=i.buffer.shift();i.prepare(e)}},1e3*t)}},H5playerBarrageQueue.prototype={init:function(e){this.initSystemMessage(),this.initGiftcomboAnimation(),e(this)},initGiftcomboAnimation:function(){var e=this;new H5playerGiftcomboAnimation(this,function(t){e.giftCombo=t})},initSystemMessage:function(){var e=this;new H5playerSystemMessage(this,function(t){e.systemMessage=t})},isEmpty:function(){return 0==this.buffer.length},clearBuffer:function(){this.buffer=[]},getBufferLen:function(){return this.buffer.length},inQueue:function(e){this.buffer.push(e)},outQueue:function(e){var t=this.getBufferLen();e<=t?this.buffer.splice(0,e):(this.buffer=[],h5playerLog("barrage buffer length less than delete length!",3))},setBarrageStatus:function(e){return this.barrageStatus=e,this.buffer=[],this},setAnimationStatus:function(e){return this.animationStatus=e,this},clearAnimationBuffer:function(){return this.setAnimationStatus(0),this.giftCombo.clearBuffer(),this.systemMessage.clearBuffer(),this},receiveMessages:function(e){for(var t=e.length,i=[],a=0;a<t;a++){var n=e[a].type;switch(n){case 1:if(1==this.barrageStatus){var r=this.takeOffContentShell(e[a].content),s=this.translateEmoji(r);i.push({content:s,uid:e[a].user.uid,type:n})}break;case 2:1==this.animationStatus&&(e[a].metaInfo&&5==e[a].metaInfo.animation?this.comboAnimation(e[a].metaInfo):this.systemMsg(e[a].content));break;case 3:1==this.animationStatus&&e[a].metaInfo&&2==e[a].metaInfo.animation&&this.comboAnimation(e[a].metaInfo);break;case 4:1==this.animationStatus&&e[a].metaInfo&&5==e[a].metaInfo.animation&&this.comboAnimation(e[a].metaInfo)}}this.buffer=this.buffer.concat(i)},takeOffContentShell:function(e){return 0==e.indexOf("<![JSON[")&&e.indexOf(!1)?JSON.parse(e.slice(8,-3)):{content:e,fontColor:""}},translateEmoji:function(e){var t=e.content;return t.indexOf("[")!=-1&&t.indexOf("]")!=-1?(e.content=CSEmoji.trans(t),e.contentFate=this.replaceEmojiText(t)):e.contentFate=t,e},replaceEmojiText:function(e){var t=e.match(/\[(\S*)\]/),i=/\d_\S*/;try{if(i.test(t[0]))return e.replace(t[0],"CS")}catch(a){return e}return e},comboAnimation:function(e){if(this.giftCombo){var t=e.animationIcon,i=(t.match(/v4\/(\S*)_/)[1],this.reformContent(e.animationText));this.giftCombo.handOver({combotext:i,icon:t,bgUrl:e.animationBg})}},systemMsg:function(e){if(this.systemMessage){var t=this.reformContent(e);this.systemMessage.handOver(t)}},reformContent:function(e){for(var t=e.match(/\<\!\[JSON\[(.*?)\]\]\>/g),i="",a="",n=0,r=t.length;n<r;n++){var s=this.takeOffContentShell(t[n]);1==s.type?(i+='<span style="color:'+s.fontColor+'">'+s.content+"</span>",a+=s.content):(i+='<img src="'+s.image+'">',a+="[图]")}return{str:i,pureStr:a}},fatedata:function(){var e=[{metaInfo:{additionType:2,animation:5,animationBg:"https://kascdn.kascend.com/jellyfish/gift/v4/gift_combo_animation_bg_v2.png",animationIcon:"https://kascdn.kascend.com/jellyfish/gift/v4/225_animation.gif",animationPriority:20,animationSwfName:"WishCrystalGift",animationText:'<![JSON[{"fontSizeLevel":4,"type":1,"content":" 清の酒 ","fontColor":"#ffe345"}]]><![JSON[{"fontSizeLevel":4,"type":1,"content":"送给","fontColor":"#ffffff"}]]><![JSON[{"fontSizeLevel":4,"type":1,"content":" 包子包子包肉肉 ","fontColor":"#ffe345"}]]><![JSON[{"fontSizeLevel":4,"type":1,"content":"许愿水晶 30连击，","fontColor":"#ffffff"}]]><![JSON[{"fontSizeLevel":4,"type":1,"content":"触海欧气爆棚，祝你心想事成！","fontColor":"#ffffff"}]]>'},user:{uid:1192671307,avatar:"https://kascdn.kascend.com/jellyfish/avatar/1192671307/1507997225913.JPG",gender:"male",nickname:"‎Ꮺ゛浮华"},type:2,medalList:[{url:"https://kascdn.kascend.com/jellyfish/user/level/39@3x.png"},{url:"https://kascdn.kascend.com/jellyfish/bigfans/online/20185/20185_10_6.png"}],content:"太吃装备了这个英雄[1_石化]",roomId:20185,recOnly:0,createdTime:1539671956749,id:23400705},{metaInfo:{additionType:2,animation:5,animationBg:"https://kascdn.kascend.com/jellyfish/gift/v4/gift_combo_animation_bg_v2.png",animationIcon:"https://kascdn.kascend.com/jellyfish/gift/v4/5_animation.gif",animationPriority:20,animationSwfName:"WishCrystalGift",animationText:'<![JSON[{"fontSizeLevel":4,"type":1,"content":" 清の酒 ","fontColor":"#ffe345"}]]><![JSON[{"fontSizeLevel":4,"type":1,"content":"送给","fontColor":"#ffffff"}]]><![JSON[{"fontSizeLevel":4,"type":1,"content":" 包子包子包肉肉 ","fontColor":"#ffe345"}]]><![JSON[{"fontSizeLevel":4,"type":1,"content":"许愿水晶 30连击，","fontColor":"#ffffff"}]]><![JSON[{"fontSizeLevel":4,"type":1,"content":"强无敌","fontColor":"#ffffff"}]]>'},user:{uid:1192671307,avatar:"https://kascdn.kascend.com/jellyfish/avatar/1192671307/1507997225913.JPG",gender:"male",nickname:"‎Ꮺ゛浮华"},type:2,medalList:[{url:"https://kascdn.kascend.com/jellyfish/user/level/39@3x.png"},{url:"https://kascdn.kascend.com/jellyfish/bigfans/online/20185/20185_10_6.png"}],content:"太吃装备了这个英雄[1_石化]",roomId:20185,recOnly:0,createdTime:1539671956749,id:23400705},{metaInfo:{additionType:2},user:{uid:1192671307,avatar:"https://kascdn.kascend.com/jellyfish/avatar/1192671307/1507997225913.JPG",gender:"male",nickname:"‎Ꮺ゛浮华"},type:2,medalList:[{url:"https://kascdn.kascend.com/jellyfish/user/level/39@3x.png"},{url:"https://kascdn.kascend.com/jellyfish/bigfans/online/20185/20185_10_6.png"}],content:'<![JSON[{"image":"https://kascdn.kascend.com/jellyfish/chat_icon_alarm_v4.png","type":2}]]><![JSON[{"type":1,"content":"主播 ","fontColor":"#ff5959"}]]><![JSON[{"style":1,"type":1,"content":"聪明萌 ","fontColor":"#ffbd00"}]]><![JSON[{"type":1,"content":"的直播间充盈着","fontColor":"#ff5959"}]]><![JSON[{"style":1,"type":1,"content":" 擎天水柱擎天水柱擎天水柱擎天水柱擎天水柱擎天水柱","fontColor":"#ffbd00"}]]><![JSON[{"type":1,"content":"，60秒后自动吐泡，点击快去蹭泡吧 ~","fontColor":"#ff5959"}]]><![JSON[{"image":"https://cdn.kascend.com/jellyfish/icon/bang/level_5.5_n_c.png","type":2}]]>',roomId:20185,recOnly:0,createdTime:1539671956749,id:23400705}],t=this;setInterval(function(){if(t.buffer.length<100){var i=Math.floor(Math.random()*e.length),a=e.slice(0,i);t.receiveMessages(a)}},800)}},H5playerBarrageTunnelManager.prototype={init:function(){this.initTunnels(),this.callback&&this.callback(this)},initTunnels:function(e){var t=$("#live-h5player-container").height();this.tunnelCount=Math.floor(t/this.singleTunnelHeight);for(var i=Date.now(),a=0;a<this.tunnelCount;a++)this.tunnels.push({index:a,sign:i,ready:!0,lastDuration:0,lastTimeStamp:0});e&&"function"==typeof e&&e()},calculateTunnelCount:function(e,t){if(this.calculating){var i=Date.now(),a=i-this.calculateTimeStamp;if(a>1e3){var n=this;a>3e3?(this.calculating=!1,this.calculateTunnelCount(e,t)):setTimeout(function(){n.calculateTunnelCount(e,t)},500)}else"function"==typeof t&&t()}else{this.calculating=!0,this.calculateTimeStamp=Date.now();var r=$("#live-h5player-container").height(),s=r,o=this.tunnels.length;0!=e&&(s*=this.BARRAGE_POSITION_NOTFULL_SCREEN),this.lastActiveCount=this.tunnelActiveCount,this.tunnelActiveCount=Math.floor(s/this.singleTunnelHeight);var l=Math.floor(r/this.singleTunnelHeight);if(l>o)for(var h=l-o,c=Date.now(),u=0;u<h;u++)this.tunnels.push({index:u+o,sign:c,ready:!0,lastDuration:0,lastTimeStamp:0});if(h5playerLog("tunnel active count "+this.tunnelActiveCount,1),2==e){var f=this.tunnels.length*this.singleTunnelHeight;r>f?this.tunnelBlankHeight=r-this.tunnels.length*this.singleTunnelHeight:this.tunnelBlankHeight=r-l*this.singleTunnelHeight;var g=Math.ceil((r-s)/this.singleTunnelHeight);this.activeTunnels=this.tunnels.slice(g,this.tunnelActiveCount+g)}else this.tunnelBlankHeight=0,this.activeTunnels=this.tunnels.slice(0,this.tunnelActiveCount);this.calculating=!1,"function"==typeof t&&t(this.activeTunnels,this.tunnelActiveCount,this.lastActiveCount)}},tunnelPositionChange:function(e,t){this.calculateTunnelCount(e,function(){t()})},getTunnelReady:function(e){var t=this.activeTunnels.filter(function(e){return e&&e.ready});e({count:t.length,tunnels:t})},setTunnelStatus:function(e,t,i){try{this.tunnels.length>e&&t==this.tunnels[e].sign&&(this.tunnels[e].ready=i)}catch(a){h5playerLog(a,3)}}},H5playerBarrageBulletManager.prototype={init:function(){this.bullets=[],this.callback(this)},inStore:function(e){this.store.push(e)},clearStore:function(){this.store=[]},getBullets:function(e,t){var i=this,a=e.length,n=this.store.filter(function(e){return e&&!e.isBusy}),r=n.length;if(r>=a){var s=n.slice(0,a);this.reformBullets(s,e,function(e){t({count:a,bullets:e})})}else this.reformBullets(n,e.slice(0,r),function(n){for(var s=a-r,o=e.slice(r),l=[],h=0;h<s;h++)i.produce(o[h],function(e){l.push(e)});t({count:a,bullets:n.concat(l)})})},reform:function(e,t,i){var a=this,n=e.bulletDom;t.uid==a.userUid?n.hasClass("h5player-barrage-item-self")||n.addClass("h5player-barrage-item-self"):n.hasClass("h5player-barrage-item-self")&&n.removeClass("h5player-barrage-item-self"),n.css("display","block"),e.barrage=t,i(e)},reformBullets:function(e,t,i){if(0==e.length)i([]);else{for(var a=[],n=0;n<e.length;n++)this.reform(e[n],t[n],function(e){a.push(e)});i(a)}},getStoreLength:function(){return this.store.length},storeIsEmpty:function(){return 0==this.store.length},produce:function(e,t){var i=this;switch(e.type){case 1:var a=e.uid==this.userUid?"h5player-barrage-item-self":"",n='<div style="tmpstyle" class="h5player-barrage-item '+a+'"></div>',r={bulletDom:$(n),isBusy:!0,barrage:e,tunnel:-1};i.inStore(r),t(r)}},hide:function(e,t,i){if(0==this.store.length||t!=-1&&t<=e)i&&"function"==typeof i&&i();else{for(var a=0,n=this.store.length;a<n;a++){var r=this.store[a].tunnel;if(r>=e&&(t==-1||r<t))try{this.store[a].bulletDom.css("display","none")}catch(s){h5playerLog("bullet hide exception, "+s,3)}}i&&"function"==typeof i&&i()}}},H5playerBarrage.prototype={barrageInit:function(e){var t=this,i=this.getBarrageParam("barrageSwitch"),a=this.getBarrageParam("barrageFullscreenInputSwitch"),n=this.getBarrageParam("barrageOpacity"),r=this.getBarrageParam("barragePosition");this.barrageConfig={barrageSwitch:""===i?e.barrageSwitch:i,barrageFullscreenInputSwitch:""===a?e.barrageFullscreenInputSwitch:a,barrageOpacity:""===n?e.barrageOpacity:n,barragePosition:""===r?e.barragePosition:r},this.queueInit(function(){t.tunnelManagerInit(function(){t.bulletManagerInit(function(){h5playerLog("barrage tunnel and bullet init finish",2),1==t.barrageConfig.barrageSwitch&&t.open(),t.callback(t)})})})},open:function(){var e=this;this.queue.setBarrageStatus(1),this.tunnelManager.calculateTunnelCount(this.barrageConfig.barragePosition,function(){e.sendTimer=setInterval(e.check.bind(e),e.barrageCheckTime)})},close:function(){this.sendTimer&&clearInterval(this.sendTimer),$(".live-h5player-barrage").html(""),this.queue.clearBuffer(),this.queue.setBarrageStatus(0),this.bulletManager.clearStore()},changePosition:function(e,t){this.tunnelManager.tunnelPositionChange(e,function(){t()})},queueInit:function(e){var t=this;new H5playerBarrageQueue({barrage:this,barrageFlySpeed:this.barrageFlySpeed,giftcomboAnimationSpeed:this.giftcomboAnimationSpeed,systemMessageSpeed:this.systemMessageSpeed},function(i){t.queue=i,e()})},tunnelManagerInit:function(e){var t=this;new H5playerBarrageTunnelManager({videoId:this.videoId,singleTunnelHeight:this.singleTunnelHeight,barragePosition:this.barrageConfig.barragePosition},function(i){t.tunnelManager=i,e()})},bulletManagerInit:function(e){var t=this;new H5playerBarrageBulletManager({userUid:this.userUid},function(i){t.bulletManager=i,e()})},check:function(){if(this.checkProtect(),!this.firing&&!this.queue.isEmpty()&&!this.tunnelManager.calculating){var e=this;this.firing=!0,this.getTunnelReady(function(t){var i=t.count;if(0!=i){var a=e.queue.buffer.slice(0,i);e.getBullets(a,function(i){0!=i.count?0==e.isAysnc?e.distribute(i.bullets,t.tunnels,0):e.asyncDistribute(i.bullets,t.tunnels,function(){e.queue.outQueue(i.count),e.firing=!1}):e.firing=!1})}else e.firing=!1})}},checkProtect:function(){var e=Date.now();0!=this.checkTime&&e-this.checkTime>2*this.barrageCheckTime&&(this.queue.clearBuffer(),this.queue.giftCombo.clearBuffer(),this.queue.systemMessage.clearBuffer()),this.checkTime=e},distribute:function(e,t,i){var a=this,n=e.length;i!=n?this.fly(e[i],t[i],function(){a.distribute(e,t,++i)}):(this.queue.outQueue(n),this.firing=!1)},asyncDistribute:function(e,t,i){var a=this,n=e.map(function(e,i){return a.asyncDistributePromise(e,t[i])});Promise.all(n).then(function(){i()})["catch"](function(e){h5playerLog("async send barrage exception "+e,3),i()})},asyncDistributePromise:function(e,t){var i=this;return new Promise(function(a,n){i.fly(e,t,function(){a()})})},fly:function(e,t,i){var a=this,n=1-.2*this.barrageConfig.barrageOpacity-.1,r=(this.barrageConfig.barragePosition,$("#live-h5player-container").width()),s=Math.floor(this.getBarrageContentLen(e.barrage.content.contentFate)*this.SINGLE_TEXT_WIDTH),o=r+s,l=this.tunnelManager.tunnelBlankHeight+t.index*this.singleTunnelHeight,h=e.barrage.content.fontColor,c=""==h?"#fff":h;if(0==this.barrageSpeedMode){var u=t.lastDuration,f=t.lastTimeStamp;if(0==u)var g=(o/this.barrageFlySpeed).toFixed(2),m=(s/this.barrageFlySpeed).toFixed(2);else{var p=(r/this.barrageFlySpeed).toFixed(2),d=r>s?(p-s/this.barrageFlySpeed).toFixed(2):this.longBarrageNeedTime,v=Date.now(),y=v-f;if(y/1e3<u){var b=(u-y/1e3).toFixed(2);if(d-b<0)var g=(o*b/r).toFixed(2),m=(s*b/r).toFixed(2);else var g=(parseFloat(s*d/r)+parseFloat(d)).toFixed(2),m=(s*d/r).toFixed(2)}else var g=(parseFloat(s*d/r)+parseFloat(d)).toFixed(2),m=(s*d/r).toFixed(2)}}else var g=(o/this.barrageFlySpeed).toFixed(2),m=(s/this.barrageFlySpeed).toFixed(2);e.bulletDom.css({top:l+"px",left:r+"px",opacity:n,visibility:"visible",transform:"translateX(0)",color:c}).html(e.barrage.content.content),e.isBusy=!0,e.tunnel=t.index,0==$(".live-h5player-barrage").find(e.bulletDom).length&&$(".live-h5player-barrage").append(e.bulletDom),setTimeout(function(){e.bulletDom.css({transform:"translateX(-"+o+"px)",transition:"transform "+g+"s linear 0s"}),t.lastDuration=g,t.lastTimeStamp=Date.now()},50),this.tunnelManager.setTunnelStatus(t.index,t.sign,!1),setTimeout(function(){e.isBusy=!1,e.bulletDom.css({transition:"none",visibility:"hidden"})},1e3*g),setTimeout(function(){a.tunnelManager.setTunnelStatus(t.index,t.sign,!0)},1e3*m),i()},getTunnelReady:function(e){this.tunnelManager?this.tunnelManager.getTunnelReady(function(t){e(t)}):e({count:0,tunnels:[]})},getBullets:function(e,t){this.bulletManager?this.bulletManager.getBullets(e,function(e){t(e)}):t({count:0,bullets:[]})},getBarrageParam:function(e){return this.player&&""!=e?this.player.getCookie(e):""},setBarrageParam:function(e,t){this.player&&(this.player.setCookie(e,t),this.barrageConfig[e]=t)},getAllBarrageParams:function(){return this.barrageConfig},getBarrageContentLen:function(e){for(var t=0,i=0;i<e.length;i++){var a=e.charAt(i);t+=null!=a.match(/[^\x00-\xff]/gi)?2:1}return t}},H5playerLive.prototype={flvjsPlayerLoad:function(e,t,i){var a=this;this.playerDestroy(function(){var n=document.getElementById(a.videoId);a.video=n,a.videoEvent(),a.player=flvjs.createPlayer(e,t),a.player.attachMediaElement(n),a.player.load(),a.logControl(),a.player.on(flvjs.Events.LOADING_COMPLETE,function(){h5playerLog("LOADING_COMPLETE",2),a.interrupt(),clearInterval(a.waitingTime)}),a.player.on(flvjs.Events.METADATA_ARRIVED,function(e){h5playerLog("METADATA_ARRIVED",2)}),a.player.on(flvjs.Events.RECOVERED_EARLY_EOF,function(){}),a.player.on(flvjs.Events.SCRIPTDATA_ARRIVED,function(){}),a.player.on(flvjs.Events.STATISTICS_INFO,function(){}),a.player.on(flvjs.Events.MEDIA_INFO,function(){a.main.onGetMideaInfo(a.player.mediaInfo)}),a.player.on(flvjs.Events.ERROR,function(e){h5playerLog(e,4)}),"function"==typeof i&&i(a.player.mediaInfo)})},logControl:function(){var e=this.main.logDebugSwitch;flvjs.LoggingControl.enableVerbose=e,flvjs.LoggingControl.enableInfo=e,flvjs.LoggingControl.enableWarn=e,flvjs.LoggingControl.enableError=e},videoEvent:function(){var e=this;this.video.onloadstart=function(){$(".live-opening").show()},this.video.onloadeddata=function(){},this.video.onprogress=function(e){},this.video.oncanplay=function(){h5playerLog("oncanplay",1),$(".live-opening").hide(),clearInterval(e.waitingTime),e.video.readyState>=3&&$(".live-loading").hide()},this.video.oncanplaythrough=function(){h5playerLog("oncanplaythrough",1),$(".live-loading").hide()},this.video.onwaiting=function(){$(".live-opening").hide(),$(".live-loading").show(),h5playerLog("waiting..",1),e.waitingHandler()}},waitingHandler:function(){var e=this;clearInterval(this.waitingTime),this.waitingTimeStart=Date.now(),this.waitingTime=setInterval(function(){var t=Date.now();t-e.waitingTimeStart>e.WAITING_TIME&&(clearInterval(e.waitingTime),e.interrupt())},1e3)},playerDestroy:function(e){this.player&&(this.isLiving=!1,this.player.pause(),this.player.destroy(),this.player=null),e&&e()},checkAutoPlay:function(e){var t=document.querySelector("video").play();void 0!==t&&t.then(function(){e()})["catch"](function(e){try{if(e.message.indexOf("interrupted by a call to pause")>-1)return}catch(t){}h5playerLog(JSON.stringify(e),3),$(".h5player-unsupport-autoplay").show()})},play:function(){var e=this;this.checkAutoPlay(function(){if(e.player)try{e.isLiving=!0,e.player.play()}catch(t){window.console&&console.log(t)}})},pause:function(){this.player&&(this.isLiving=!1,this.player.pause())},refresh:function(){this.stream&&this.setPlayUrl(this.stream.getCurrentStreamUrl())},initPlayerSound:function(){var e=this.getIsMute(),t=this.getVolume();e?this.setVolume(0):""==t?this.setVolume(this.DEFAULT_VOLUME):this.setVolume(t)},getVolume:function(){var e=this.getCookie("volume");return""==e?this.DEFAULT_VOLUME:e},setVolume:function(e){this.video&&(e<0?e=0:e>100&&(e=100),this.video.volume=e/100),e>0&&this.setCookie("mute",!1),this.setCookie("volume",e)},getIsMute:function(){var e=this.getCookie("mute");return""!=e&&e},setMute:function(){this.video&&(this.video.volume=0),this.setCookie("mute",!0)},cancelMute:function(){if(this.video){var e=this.getVolume();this.video.volume=e}this.setCookie("mute",!1)},getCurrentTime:function(e){e(this.player.buffered.length>0?this.player.buffered.end(0):null)},seekTo:function(e){e&&(this.player.currentTime=parseFloat(e)-1)},getLiveStreamUrl:function(e,t){var i=this,a={roomId:this.roomId,host:this.host};this.setOffLive(!1),this.stream&&!e?(this.refresh(),t&&t(i)):this.stream=new H5playerStreamManager(a,function(e){e?t(i,null,e):i.setPlayUrl(i.stream.getCurrentStreamUrl(),function(e,a){t&&t(i,e,a)})})},setPlayUrl:function(e,t){var i=this,a=this.generateFlvObject(e),n={enableStashBuffer:!1,enableWorker:!1,autoCleanupSourceBuffer:!0};a?this.flvjsPlayerLoad(a,n,function(e){i.initPlayerSound(),t&&"function"==typeof t&&t(e,null),setTimeout(function(){i.play()},100)}):(t&&"function"==typeof t&&t(null,"流格式解析错误,url:"+e),h5playerLog("流格式解析错误,url:"+e,4))},generateFlvObject:function(e){var t=e.split("?")[0],i=t.lastIndexOf("."),a=t.slice(i+1),n=["flv"];return n.indexOf(a)>-1?{type:a,url:e,isLive:!0,hasAudio:!0,hasVideo:!0,cors:!0}:null},getStreamData:function(){return this.stream?this.stream.getStreamNameList():[]},getStreamIndex:function(){return this.stream?this.stream.getCurrentStreamDefinitionIndex():0},setStreamDefinition:function(e,t){this.stream&&this.stream.setStreamDefinition(e)&&(this.setPlayUrl(this.stream.getCurrentStreamUrl()),t())},setCookie:function(e,t){var i=JSON.parse(this.getCookie(""));i[e]=t;var a=JSON.stringify(i),n=new Date;n.setDate(n.getDate()+this.COOKIE_EXPIRE_DAYS),document.cookie=this.COOKIE_NAME+"="+a+(null==this.COOKIE_EXPIRE_DAYS?"":";expires="+n.toGMTString())},getCookie:function(e){if(document.cookie.length>0){var t=document.cookie.indexOf(this.COOKIE_NAME+"=");if(t!=-1){t=t+this.COOKIE_NAME.length+1;var i=document.cookie.indexOf(";",t);if(i==-1&&(i=document.cookie.length),""==e)return document.cookie.substring(t,i);var a=JSON.parse(document.cookie.substring(t,i));return"undefined"!=typeof a[e]?a[e]:""}}return""==e?"{}":""},offLive:function(e,t){var i=this;this.isLiving=!1,this.setOffLive(!0);var a={url:this.host+"/room/get-recommend.htm?roomId="+e,type:"GET",cache:!1,dataType:"json",success:function(e){var a={num:0,html:""};if(0==e.code){var n=e.data,r=n.length;if(0!=r){a.num=r;for(var s=0;s<r;s++){var o=n[s];if(1==o.type){var l=o.meta.gender;a.html+='<a class="recommend-item recommend-item-live singleClass" href="'+i.host+"/room/"+o.targetKey+'.htm"><img src="'+o.cover+'" alt="" class="live-over-rec-img"><div class="rec-info-box"><p class="rec-info-title ellipsis">'+escapeString(o.name)+'</p><div class="rec-info-content"><p class="rec-info-live ellipsis"><i class="live-over-gender-'+l+'"></i><span class="rec-anchor-name ellipsis">'+escapeString(o.meta.creator)+'</span><i class="live-over-room-hot"></i><span>'+formateNumber(o.meta.onlineCount)+'</span></p><p class="rec-info-livearea ellipsis">'+o.meta.gameName+'</p></div></div><img src="./imgs/h5player/over/angle_icon_live.png" alt="" class="rec-angle-icon angle-icon-live"></a>'}else 3==o.type&&(a.html+=' <a class="recommend-item recommend-item-video singleClass"  href="'+i.host+"/gamezone/video/play/"+o.targetKey+'.htm"><img src="'+o.cover+'" alt="" class="live-over-rec-img"><div class="rec-info-box"><p class="rec-info-title ellipsis">'+escapeString(o.name)+'</p><div class="rec-info-content"><i class="live-over-video-gift"></i><span>'+formateNumber(o.meta.giftCount)+'</span><i class="live-over-video-play"></i><span>'+formateNumber(o.meta.playCount)+'</span><i class="live-over-video-comments"></i><span>'+formateNumber(o.meta.commentCount)+'</span></div></div><img src="./imgs/h5player/over/angle_icon_video.png" alt="" class="rec-angle-icon angle-icon-video"></a>')}}}t(a)}};$.ajax(a)},interrupt:function(){this.everOffLive||(this.setOffLive(!0),this.isLiving=!1,this.playerDestroy(),$(".live-opening,.live-loading").hide(),$(".live-interrupt").show(),$(".h5player-unsupport-autoplay").hide())},setOffLive:function(e){this.everOffLive=e}},H5playerControlBar.prototype={init:function(){this.controBarStatusInit(),this.operate(),this.callback(this)},controBarStatusInit:function(){this.videoWidth=$(".live-h5player-container").width(),this.videoHeight=$(".live-h5player-container").height(),$(".h5player-pauseplay").removeClass("h5player-pauseplay-switch").attr("data-status",1).find(".controlbar-tip").text("暂停");var e=this.player.getIsMute(),t=this.player.getVolume();this.setVolume(t,e);var i=this.player.getStreamData(),a=this.player.getStreamIndex(),n=i.length,r="";if(n>0){var s=i[a].def;$("");for(var o=0;o<n;o++)r+='<p class="definition-item" data-def="'+i[o].def+'">'+i[o].str+"</p>";$(".definition-items").html(r),this.setStreamDefinition(a,s)}else $(".definition-items").html("");var l=this;$(".live-h5player-container").contextmenu(function(e){if(l.main.switchTime&&H5player.isThisBrowser("firefox")){var t=Date.now();if(t-l.main.switchTime<200)return!1}var i=$(document).scrollTop(),a=e.clientX,n=e.clientY,r=$(".live-h5player-container").offset().left,s=$(".live-h5player-container").offset().top-i,o=a-r,h=n-s,c=$(".live-h5player-rightmenu").width(),u=$(".live-h5player-rightmenu").height(),f=$(".live-h5player-container").width(),g=$(".live-h5player-container").height(),m=o+c>f?o-c:o,p=h+u>g?h-u:h;
return $(".live-h5player-rightmenu").css({top:p,left:m}).show(),!1});var h=this.barrage.getAllBarrageParams();this.importBarrageConfig(h)},operate:function(){function e(e){$(document).on("mousemove",null,t),$(document).on("mouseup",null,i),e.preventDefault(),e.stopPropagation()}function t(e){var t=$(".volume-line").offset().top,i=e.clientY,n=i-t;if(n>75)var r=0;else if(n<0)var r=100;else var r=Math.floor(100*(75-n)/75);a.setVolume(r,!1),event.preventDefault(),event.stopPropagation()}function i(e){$(document).off("mousemove",null,t),$(document).off("mouseup",null,i),e.preventDefault(),e.stopPropagation()}var a=this;$(".h5player-pauseplay").click(function(){var e=parseInt($(this).attr("data-status"));if(1==e){var t="播放";a.player.pause()}else{var t="暂停";a.player.getCurrentTime(function(e){a.player.seekTo(e),a.player.play()})}e=1-e,$(this).toggleClass("h5player-pauseplay-switch").attr("data-status",e).find(".controlbar-tip").text(t)}),$(".h5player-reload").click(function(){"0"==$(".h5player-pauseplay").attr("data-status")&&$(".h5player-pauseplay").removeClass("h5player-pauseplay-switch").attr("data-status",1).find(".controlbar-tip").text("暂停"),a.player.refresh()}),$(".h5player-fullscreen").click(function(){a.isFullScreen?($(".h5player-fullscreen").removeClass("h5player-fullscreen-ing"),a.exitFullScreen()):($(".h5player-fullscreen").addClass("h5player-fullscreen-ing"),a.requestFullScreen($("#live-h5player-container").get(0)))}),$(".h5player-pagescreen").click(function(){a.theaterMode()}),$("#live-h5player-container").dblclick(function(e){e.target;e.target.className.indexOf("live-h5player-controlbar")==-1&&0==$(e.target).parents(".live-h5player-controlbar").length&&a.theaterMode()}),$(".h5player-rotate").click(function(){a.videoRotateDeg+=90,a.videoRotateDeg=a.videoRotateDeg%360,a.main.setPlayerSize()}),$(document).bind("fullscreenchange webkitfullscreenchange mozfullscreenchange",function(){a.checkFull()?a.fullScreenVideoChange():a.exitFullScreenVideoChange()}),$(".h5player-volume").click(function(e){if(e.target.classList.value.indexOf("h5player-volume")>-1)if($(this).hasClass("h5player-volume-mute")){$(this).removeClass("h5player-volume-mute");var t=a.player.getVolume();a.setVolume(t,!1)}else $(this).addClass("h5player-volume-mute"),a.setVolume(0,!0)}),$(".volume-line").click(function(e){var t=$(".volume-line").offset().top,i=e.clientY,n=i-t,r=Math.floor(100*(75-n)/75);a.setVolume(r,!1)}),$(".volume-ball").on("mousedown",null,e),$(document).keydown(function(e){var t=e||window.event,i=t.keyCode||t.which;if(!$(".volume-line").is(":hidden"))switch(i){case 38:var n=a.getVolume();n>=95?a.setVolume(100,!1):a.setVolume(n+5,!1);break;case 40:var n=a.getVolume();n<=5?a.setVolume(0,!0):a.setVolume(n-5,!1)}}),$("body").on("click",".definition-item",function(){if(!$(this).hasClass("active")){var e=$(this).index(),t=$(this).data("def");a.player.setStreamDefinition(e,function(){a.setStreamDefinition(e,t)})}}),$(".h5player-barrage").click(function(e){if(e.target.classList.value.indexOf("h5player-barrage")>-1){var t=$(this).attr("data-status");a.barrageSwitch=t,0==t?($(this).find(".controlbar-tip").text("关闭弹幕"),a.barrage.open()):($(this).find(".controlbar-tip").text("开启弹幕"),a.barrage.close()),t=1-t,$(this).attr("data-status",t),a.setBarrageParam("barrageSwitch",t),$(this).toggleClass("h5player-barrage-off")}}),$(".barrage-fullscreen-input-switch").click(function(){var e=$(this).data("value");$(this).addClass("active").siblings(".barrage-fullscreen-input-switch").removeClass("active"),a.setBarrageParam("barrageFullscreenInputSwitch",e)}),$(".barrage-opacity-choice").click(function(){var e=$(this).data("value");$(this).addClass("active").siblings(".barrage-opacity-choice").removeClass("active"),a.setBarrageParam("barrageOpacity",e)}),$(".barrage-position-choice").click(function(){if(!$(this).hasClass("active")){var e=$(this).data("value");$(this).addClass("active").siblings(".barrage-position-choice").removeClass("active"),a.barrage.changePosition(e,function(){a.setBarrageParam("barragePosition",e)})}}),$(".live-h5player-container").hover(function(){a.player.everOffLive||($("#live-h5player-container .live-time").hasClass("live-time-hidden")&&$("#live-h5player-container .live-time").removeClass("live-time-hidden"),$(".live-h5player-controlbar").hasClass("live-h5player-controlbar-show")||$(".live-h5player-controlbar").addClass("live-h5player-controlbar-show"))},function(){$("#live-h5player-container .live-time").hasClass("live-time-hidden")||$("#live-h5player-container .live-time").addClass("live-time-hidden"),$(".live-h5player-controlbar").hasClass("live-h5player-controlbar-show")&&$(".live-h5player-controlbar").removeClass("live-h5player-controlbar-show")}),$(".live-h5player-container").click(function(){$(".live-h5player-rightmenu").hide()}),$(".h5plyaer-switch-flash").click(function(){a.main.destroy(),$(".live-h5player-rightmenu").hide()}),$(".unsupport-autoplay-btn").click(function(){$(".h5player-unsupport-autoplay").hide();try{a.player.getCurrentTime(function(e){a.player.seekTo(e),a.player.play()})}catch(e){h5playerLog("自动播放按钮异常:"+e,4)}}),$(".live-interrupt-refresh").click(function(){location.href=location.href})},setBarrageParam:function(e,t){this.barrage&&this.barrage.setBarrageParam(e,t)},importBarrageConfig:function(e){0==e.barrageSwitch&&($(".h5player-barrage").addClass("h5player-barrage-off"),$(".h5player-barrage").attr("data-status",e.barrageSwitch)),0==e.barrageFullscreenInputSwitch&&($(".barrage-fullscreen-input-off").addClass("active"),$(".barrage-fullscreen-input-on").removeClass("active"));var t=e.barrageOpacity;$(".barrage-opacity-choice"+t).addClass("active").siblings(".barrage-opacity-choice").removeClass("active");var i=e.barragePosition;$(".barrage-position-choice"+i).addClass("active").siblings(".barrage-position-choice").removeClass("active")},setVolume:function(e,t){if(t||0==e)this.player.setMute(),$(".h5player-volume").addClass("h5player-volume-mute"),$(".volume-ball").css({bottom:"20px"}),$(".volume-percent").text("静音").css({bottom:"15px"}),$(".volume-line-gray").css("marginTop","0"),this.volume=0;else{this.player.setVolume(e),$(".h5player-volume").removeClass("h5player-volume-mute");var i=75*e/100,a=20+i;$(".volume-ball").css({bottom:a+"px"});var n=a-5;$(".volume-percent").text(e+"%").css({bottom:n+"px"}),$(".volume-line-gray").css("marginTop","-"+i+"px"),this.volume=e}},getVolume:function(){return this.volume},requestFullScreen:function(e){var t=e.requestFullScreen||e.webkitRequestFullScreen||e.mozRequestFullScreen||e.msRequestFullScreen;if(t)t.call(e);else if("undefined"!=typeof window.ActiveXObject){var i=new ActiveXObject("WScript.Shell");null!==i&&i.SendKeys("{F11}")}},fullScreenVideoChange:function(e){this.isPageScreen&&(this.isPageScreen=!1,$(".h5player-pagescreen").removeClass("h5player-pagescreen-ing").find(".controlbar-tip").text("剧场模式"),videoTheaterMode(0)),this.isFullScreen=!0,$(".h5player-fullscreen").addClass("h5player-fullscreen-ing").find(".controlbar-tip").text("退出全屏"),this.main.setPlayerSize(),NewSwfGiftAnimation&&NewSwfGiftAnimation.insertToH5player(),barragePacket&&barragePacket.setPacketParent(1),packRoom&&packRoom.insertToH5player()},exitFullScreen:function(){var e=document.exitFullscreen||document.webkitExitFullscreen||document.mozCancelFullScreen||document.msExitFullScreen;if(e)e.call(document);else if("undefined"!=typeof window.ActiveXObject){var t=new ActiveXObject("WScript.Shell");null!==t&&t.SendKeys("{ESC}")}},exitFullScreenVideoChange:function(){this.isFullScreen=!1,$(".h5player-fullscreen").removeClass("h5player-fullscreen-ing").find(".controlbar-tip").text("窗口全屏"),this.main.setPlayerSize(),"object"==typeof NewSwfGiftAnimation&&NewSwfGiftAnimation.divorcedFromH5player(),"object"==typeof barragePacket&&barragePacket.setPacketParent(0).remove(),"object"==typeof packRoom&&packRoom.divorcedFromH5player()},checkFull:function(){var e=document.fullscreenEnabled||window.fullScreen||document.webkitIsFullScreen||document.msFullscreenEnabled;return void 0===e&&(e=!1),e},setStreamDefinition:function(e,t){$(".definition-item").eq(e).addClass("active").siblings(".definition-item").removeClass("active"),$(".definition-text").attr("class","definition-text definition-"+t)},theaterMode:function(){var e=this;this.isPageScreen?(this.isPageScreen=!1,$(".h5player-pagescreen").removeClass("h5player-pagescreen-ing").find(".controlbar-tip").text("剧场模式"),videoTheaterMode(0)):(this.isFullScreen&&($(".h5player-fullscreen").removeClass("h5player-fullscreen-ing"),this.exitFullScreen()),this.isPageScreen=!0,$(".h5player-pagescreen").addClass("h5player-pagescreen-ing").find(".controlbar-tip").text("退出剧场模式"),videoTheaterMode(1)),setTimeout(function(){e.main.setPlayerSize()},300)}},H5player.prototype={init:function(e){if(flvjs.isSupported()){var t=this;this.logInit(),$(".h5player-rightmenu-item").eq(0).text("HTML5 Live Player v"+this.h5playerVersion),this.h5liveplayerInit(function(i){i?e(i):(h5playerLog("live player init finish",2),t.barrageInit(function(){h5playerLog("barrage init finish",2),t.controlBarInit(function(){window.console&&console.log("h5player init all..."),$("#live-h5player-container").show(),e&&"function"==typeof e&&e()})}))}),t.bind()}else e&&"function"==typeof e&&e("当前浏览器不支持HTML5播放")},h5liveplayerInit:function(e){var t={roomId:this.roomId,host:this.host,videoId:this.videoId,cookieName:this.COOKIE_NAME,cookieExpireDays:this.COOKIE_EXPIRE_DAYS,defaultVolume:this.DEFAULT_VOLUME,main:this},i=this;new H5playerLive(t,function(t,a,n){n?e(n):(i.player=t,a&&a.width&&(i.mediaInfo=a),i.setPlayerSize(),e())})},controlBarInit:function(e){var t={player:this.player,videoId:this.videoId,barrage:this.barrage,main:this},i=this;new H5playerControlBar(t,function(t){i.controlBar=t,e()})},barrageInit:function(e){var t=this,i={player:this.player,videoId:this.videoId,barrageSwitch:this.DEFAULT_BARRAGE_SWITCH,barrageFullscreenInputSwitch:this.DEFAULT_BARRAGE_FULLSCREEN_INPUT_SWITCH,barrageOpacity:this.DEFAULT_BARRAGE_OPACITY,barragePosition:this.DEFAULT_BARRAGE_POSITION,cookieName:this.COOKIE_NAME,cookieExpireDays:this.COOKIE_EXPIRE_DAYS,singleTunnelHeight:this.SINGLE_TUNNEL_HEIGHT,barrageFlySpeed:this.BARRAGE_FLY_SPEED,barrageCheckTime:this.BARRAGE_CHECK_TIME,barrageSpeedMode:this.BARRAGE_SPEED_MODE,barrageMaxSpeed:this.BARRAGE_MAX_SPEED,longBarrageNeedTime:this.LONG_BARRAGE_NEED_TIME,systemMessageSpeed:this.SYSTEM_MESSAGE_FLY_SPEED,giftcomboAnimationSpeed:this.GIFTCOMBO_ANIMATION_FLY_SPEED,userUid:this.userUid};new H5playerBarrage(i,function(i){t.barrage=i,e()})},setPlayerSize:function(){var e=this.mediaInfo.width,t=this.mediaInfo.height,i=$("#live-h5player-container").width(),a=$("#live-h5player-container").height();if(this.controlBar&&(this.controlBar.videoWidth=i,this.controlBar.videoHeight=a),this.controlBar&&this.controlBar.videoRotateDeg/90%2==1){var n=a,r=i,s=(n/r).toFixed(2),o=(e/t).toFixed(2);if(o>=s)var l=n,h=(n-c)/2;else var l=r*(e/t).toFixed(2),h=0;$(".live-h5player-video-box").css({width:l+"px",marginTop:h})}else{var n=i,r=a,s=(n/r).toFixed(2),o=(e/t).toFixed(2);if(o>=s)var l="100%",c=n*(t/e).toFixed(2),h=(r-c)/2;else var l=r*(e/t).toFixed(2),c="100%",h=0;$(".live-h5player-video-box").css({width:l,height:c,marginTop:h})}this.controlBar&&$(".live-h5player-video-box").css({transform:"rotate("+this.controlBar.videoRotateDeg+"deg)"}),this.resizeGiftAnimation(i,a)},resizeGiftAnimation:function(e,t){if("object"==typeof NewSwfGiftAnimation)if(e>=760)if(t>=660)NewSwfGiftAnimation.resize(660,560);else{var i=Math.floor(660*(t-100)/560);NewSwfGiftAnimation.resize(i,t-100)}else if(t>=660){var a=Math.floor(560*(e-100)/660);NewSwfGiftAnimation.resize(e-100,a)}else if((e-100)/(t-100)>660/560){var i=Math.floor(660*(t-100)/560);NewSwfGiftAnimation.resize(i,t-100)}else{var a=Math.floor(560*(e-100)/660);NewSwfGiftAnimation.resize(e-100,a)}},switchBack:function(){this.player&&($("#live-h5player-container,.live-opening").show(),this.switchTime=Date.now(),this.player.everOffLive?(this.player.setOffLive(!1),this.onLive()):(this.barrage.queue.setBarrageStatus(1).setAnimationStatus(1),this.player.getLiveStreamUrl(!1)))},destroy:function(){$("#live-h5player-container").hide(),this.player&&(this.player.playerDestroy(),$(".live-h5player-barrage").html(""),$("#system-message,#giftcombo-animation").hide(),this.barrage.queue.setBarrageStatus(0).clearAnimationBuffer(),this.controlBar.checkFull()&&this.controlBar.exitFullScreen()),H5ChangeToFlash()},logInit:function(){this.logDebugLevel=this.getUrlParam("h5playerdebug"),this.logDebugSwitch=!isNaN(this.logDebugLevel)&&this.logDebugLevel>0,this.logDebugSwitch?(window.h5playerLog=this.log,window.h5playerLogLevel=parseInt(this.logDebugLevel)):window.h5playerLog=function(){}},log:function(e,t){if(window.console){var i={1:"[debug]",2:"[info]",3:"[warn]",4:"[error]"};t>=h5playerLogLevel&&console.log("h5playerlog:"+i[t]+" > "+e)}},getUrlParam:function(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)"),i=window.location.search.substr(1).match(t);return null!=i?decodeURI(i[2]):null},onGetMideaInfo:function(e){this.mediaInfo=e,this.setPlayerSize()},bind:function(){var e=this;$(window).resize(function(){setTimeout(function(){e.setPlayerSize(),e.barrage&&e.barrage.tunnelManager&&e.barrage.tunnelManager.calculateTunnelCount(e.barrage.barrageConfig.barragePosition,function(t,i,a){if(a>i||2==e.barrage.barrageConfig.barragePosition){var n=t[t.length-1].index+1;e.barrage.bulletManager.hide(n,-1,function(){})}})},300)})},isLiving:function(){return!!this.player&&this.player.isLiving},updateLiveTime:function(e){var t="",i=Math.floor(e/1e3);if(e<6e4)t="刚刚开播";else if(e>6e4&&e<36e5){var a=Math.floor(i/60);t=" 已开播："+a+"分钟"}else{var n=Math.floor(i/3600),a=Math.floor((i-3600*n)/60);if(n>=10)var t="已开播：超过10小时";else var t="已开播："+n+"小时"+a+"分钟"}$(".live-time-now").text(t)},onLive:function(e){var t=this;$(".live-interrupt,.live-loading,.live-over").hide(),this.barrage.queue.setBarrageStatus(1).setAnimationStatus(1),this.player.getLiveStreamUrl(!0,function(i,a,n){n?e&&"function"==typeof e&&e(n):(a&&a.width&&(t.mediaInfo=a),t.setPlayerSize(),e&&"function"==typeof e&&e())})},offLive:function(){var e=this;this.player&&(this.player.playerDestroy(),$(".live-h5player-barrage").html(""),$("#system-message,#giftcombo-animation").hide(),this.barrage.queue.setBarrageStatus(0).clearAnimationBuffer(),this.player.offLive(e.roomId,function(t){0==t.num?($(".live-over-recommend").hide(),$(".live-over-tip").css("marginTop","127px")):($(".live-over-tip").css("marginTop","0"),$(".live-over-recommend").html(t.html).show()),$(".back-to-home").attr("href",e.host+"/home.htm"),$(".h5player-unsupport-autoplay,.live-interrupt,.live-loading").hide(),$(".live-over").show()}))}},H5player.isThisBrowser=function(e){var t=navigator.userAgent.toLowerCase(),i={ie:/msie\s([\d.]+)/,chrome:/chrome\/([\d.]+)/,firefox:/firefox\/([\d.]+)/,opera:/opera\/.*version\/([\d.]+)/,safari:/version\/([\d.]+).*safari/,edge:/Windows NT 6.1; Trident\/7.0;/},a=i[e]?i[e]:new RegExp(e,"g");return!!a.test(t)},H5player.isSupported=function(e){return window.MediaSource&&window.MediaSource.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"')&&!this.isThisBrowser("ie")};